version: '3.8'

services:
  automation-aio:
    image: ghcr.io/workerspages/automation-aio:autokey
    container_name: automation-aio
    ports:
      - "5000:5000"
    environment:
      - VNC_PW=admin
      - SECRET_KEY=your-secret-key-change-this
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=admin123

      # === 数据库配置 (可选：连接外部 MariaDB) ===
      # --- 数据库 (可选，留空默认使用内置 SQLite) ---
      # 如需外接 MariaDB/MySQL，请填写以下变量:
      - MARIADB_HOST= # 例如: 192.168.1.100
      - MARIADB_PORT=3306
      - MARIADB_USER=root
      - MARIADB_PASSWORD=root
      - MARIADB_DB=automation_aio
      # =======================================

      # Telegram 通知配置
      - TELEGRAM_BOT_TOKEN=
      - TELEGRAM_CHAT_ID=

      # === 邮件通知配置 ===
      - ENABLE_EMAIL_NOTIFY=true
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USER=your_email@gmail.com
      - SMTP_PASSWORD=your_app_password
      - EMAIL_FROM=your_email@gmail.com
      - EMAIL_TO=receiver@example.com

      - ENABLE_CLOUDFLARE_TUNNEL=false

      # === Cloudflare Tunnel 配置 ===
      # 模式 A: Token (推荐 - 固定域名)
      # 1. 在 Cloudflare 面板创建 Tunnel，获取 Token。
      # 2. 在 Cloudflare 面板配置 Public Hostname (例如: app.example.com -> http://localhost:5000)
      - CLOUDFLARE_TUNNEL_TOKEN=

      # 模式 B: Quick Tunnel (测试用 - 随机域名)
      # 1. 设置 ENABLE_CLOUDFLARE_TUNNEL=true
      # 2. 留空 CLOUDFLARE_TUNNEL_TOKEN
      # 3. 启动后查看日志获取随机域名 (例如: https://random-name.trycloudflare.com)

      # === 应用公网域名 (可选) ===
      # 用于在通知(邮件/Telegram)中生成正确的访问链接
      - APP_PUBLIC_DOMAIN=

      - DISPLAY=:1
    volumes:
      - ./Downloads:/home/headless/Downloads
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    shm_size: '2gb'
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
