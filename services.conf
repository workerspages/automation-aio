[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:vncserver]
# === ğŸ’€ ç»ˆææ¸…ç†ï¼šå½»åº•æ€æ­»åƒµå°¸è¿›ç¨‹ ===
# 1. rm /etc/xdg/...: åˆ é™¤ç³»ç»Ÿçº§çš„ AutoKey è‡ªå¯åŠ¨æ–‡ä»¶ (å…³é”®ï¼)
# 2. rm .cache: æš´åŠ›æ¸…ç©ºæ•´ä¸ªç¼“å­˜ç›®å½•ï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½•ä¼šè¯è®°å¿†
# 3. xfconf-query: ä¿®æ”¹ XFCE è®¾ç½®ï¼Œæ°¸ä¹…ç¦æ­¢"æ³¨é”€æ—¶ä¿å­˜ä¼šè¯"
# 4. rm .config/autostart: åˆ é™¤ç”¨æˆ·çº§è‡ªå¯åŠ¨
command=/bin/bash -c "rm -f /etc/xdg/autostart/autokey.desktop; rm -rf /home/headless/.cache; rm -rf /home/headless/.config/autostart; rm -f /home/headless/.dbus-env; rm -f /tmp/.X1-lock /tmp/.X11-unix/X1; su - headless -c 'mkdir -p /home/headless/.config/xfce4/xfconf/xfce-perchannel-xml; echo \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><channel name=\\\"xfce4-session\\\" version=\\\"1.0\\\"><property name=\\\"general\\\" type=\\\"empty\\\"><property name=\\\"SaveOnExit\\\" type=\\\"bool\\\" value=\\\"false\\\"/></property></channel>\" > /home/headless/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml; vncserver :1 -geometry 1360x768 -depth 24 -rfbport 5901 -localhost no -fg'"
autostart=true
autorestart=true
stdout_logfile=/app/logs/vncserver.log
stderr_logfile=/app/logs/vncserver-error.log
priority=10

[program:novnc]
command=/usr/bin/websockify --web=/usr/share/novnc 6901 localhost:5901
autostart=true
autorestart=true
stdout_logfile=/app/logs/novnc.log
stderr_logfile=/app/logs/novnc-error.log
user=headless
priority=20

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx-error.log
priority=30

[program:webapp]
command=/bin/bash -c "while [ ! -f /home/headless/.dbus-env ]; do sleep 1; done; source /home/headless/.dbus-env; exec /opt/venv/bin/gunicorn --workers 1 --threads 8 --timeout 300 --bind 0.0.0.0:8000 app:app"
directory=/app/web-app
autostart=true
autorestart=true
stdout_logfile=/app/logs/webapp.log
stderr_logfile=/app/logs/webapp-error.log
user=headless
environment=HOME="/home/headless",USER="headless",PATH="/opt/venv/bin:%(ENV_PATH)s",DISPLAY=":1",PLAYWRIGHT_BROWSERS_PATH="/opt/playwright",XAUTHORITY="/home/headless/.Xauthority"
priority=40

[program:autokey]
# è¿™é‡Œçš„é…ç½®ä¿æŒä¸å˜ï¼Œè´Ÿè´£å¯åŠ¨çœŸæ­£çš„ AutoKey è¿›ç¨‹
command=/bin/bash -c "mkdir -p /tmp/runtime-headless && chmod 700 /tmp/runtime-headless && rm -f /home/headless/.config/autokey/autokey.pid; rm -f /home/headless/.config/autokey/*.lock; rm -rf /tmp/runtime-headless/*; while [ ! -f /home/headless/.dbus-env ]; do sleep 1; done; source /home/headless/.dbus-env; echo 'Waiting for XFCE Panel...'; while ! pgrep -x xfce4-panel > /dev/null; do sleep 1; done; echo 'Panel is up!'; sleep 5; exec /usr/bin/autokey-gtk --verbose"
environment=HOME="/home/headless",USER="headless",DISPLAY=":1",XAUTHORITY="/home/headless/.Xauthority",XDG_CONFIG_HOME="/home/headless/.config",XDG_RUNTIME_DIR="/tmp/runtime-headless",NO_AT_BRIDGE="1"
user=headless
autostart=true
autorestart=true
stdout_logfile=/app/logs/autokey.log
stderr_logfile=/app/logs/autokey-error.log
priority=50
