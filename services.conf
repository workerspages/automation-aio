[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:vncserver]
# === 核心修复 ===
# 将所有清理操作移动到最先启动的服务中，防止竞态条件
# 1. rm autokey.desktop: 彻底切断 XFCE 的自动启动源
# 2. rm .cache/sessions: 删除 XFCE 的会话记忆
# 3. rm .dbus-env: 清理旧环境变量
command=/bin/bash -c "rm -f /home/headless/.config/autostart/autokey.desktop; rm -rf /home/headless/.cache; rm -f /home/headless/.dbus-env; rm -f /tmp/.X1-lock /tmp/.X11-unix/X1; su - headless -c 'vncserver :1 -geometry 1360x768 -depth 24 -rfbport 5901 -localhost no -fg'"
autostart=true
autorestart=true
stdout_logfile=/app/logs/vncserver.log
stderr_logfile=/app/logs/vncserver-error.log
priority=10

[program:novnc]
command=/usr/bin/websockify --web=/usr/share/novnc 6901 localhost:5901
autostart=true
autorestart=true
stdout_logfile=/app/logs/novnc.log
stderr_logfile=/app/logs/novnc-error.log
user=headless
priority=20

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx-error.log
priority=30

[program:webapp]
command=/bin/bash -c "while [ ! -f /home/headless/.dbus-env ]; do sleep 1; done; source /home/headless/.dbus-env; exec /opt/venv/bin/gunicorn --workers 1 --threads 8 --timeout 300 --bind 0.0.0.0:8000 app:app"
directory=/app/web-app
autostart=true
autorestart=true
stdout_logfile=/app/logs/webapp.log
stderr_logfile=/app/logs/webapp-error.log
user=headless
environment=HOME="/home/headless",USER="headless",PATH="/opt/venv/bin:%(ENV_PATH)s",DISPLAY=":1",PLAYWRIGHT_BROWSERS_PATH="/opt/playwright",XAUTHORITY="/home/headless/.Xauthority"
priority=40

[program:autokey]
# mkdir: 创建运行时目录
# rm: 清理锁文件
# pgrep: 等待 XFCE 面板启动
command=/bin/bash -c "mkdir -p /tmp/runtime-headless && chmod 700 /tmp/runtime-headless && rm -f /home/headless/.config/autokey/autokey.pid; rm -f /home/headless/.config/autokey/*.lock; rm -rf /tmp/runtime-headless/*; while [ ! -f /home/headless/.dbus-env ]; do sleep 1; done; source /home/headless/.dbus-env; echo 'Waiting for XFCE Panel...'; while ! pgrep -x xfce4-panel > /dev/null; do sleep 1; done; echo 'Panel is up!'; sleep 5; exec /usr/bin/autokey-gtk --verbose"
environment=HOME="/home/headless",USER="headless",DISPLAY=":1",XAUTHORITY="/home/headless/.Xauthority",XDG_CONFIG_HOME="/home/headless/.config",XDG_RUNTIME_DIR="/tmp/runtime-headless",NO_AT_BRIDGE="1"
user=headless
autostart=true
autorestart=true
stdout_logfile=/app/logs/autokey.log
stderr_logfile=/app/logs/autokey-error.log
priority=50
