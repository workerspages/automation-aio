[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:vncserver]
# Openbox 启动极快，这里只需要清理旧的锁文件即可
command=/bin/bash -c "rm -f /home/headless/.dbus-env; rm -f /tmp/.X1-lock /tmp/.X11-unix/X1; rm -f /home/headless/.config/autokey/autokey.pid; mkdir -p /tmp/runtime-headless && chmod 700 /tmp/runtime-headless; su - headless -c 'vncserver :1 -geometry 1024x600 -depth 16 -rfbport 5901 -localhost no -fg'"
autostart=true
autorestart=true
stdout_logfile=/app/logs/vncserver.log
stderr_logfile=/app/logs/vncserver-error.log
priority=10

[program:novnc]
command=/usr/bin/websockify --web=/usr/share/novnc 6901 localhost:5901
autostart=true
autorestart=true
stdout_logfile=/app/logs/novnc.log
stderr_logfile=/app/logs/novnc-error.log
user=headless
priority=20

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx-error.log
priority=30

[program:webapp]
# 直接使用系统 python3，不需要 /opt/venv/bin/ 前缀了
command=/bin/bash -c "while [ ! -f /home/headless/.dbus-env ]; do sleep 1; done; source /home/headless/.dbus-env; exec gunicorn --workers 1 --threads 4 --timeout 300 --worker-class gthread --max-requests 100 --max-requests-jitter 10 --bind 0.0.0.0:8000 app:app"
directory=/app/web-app
autostart=true
autorestart=true
stdout_logfile=/app/logs/webapp.log
stderr_logfile=/app/logs/webapp-error.log
user=headless
environment=HOME="/home/headless",USER="headless",DISPLAY=":1",PLAYWRIGHT_BROWSERS_PATH="/opt/playwright",XAUTHORITY="/home/headless/.Xauthority"
priority=40

# 注意：[program:autokey] 已经被移除！
# 它现在由 Openbox 的 autostart 文件管理。
