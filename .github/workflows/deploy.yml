name: Build and Push to Private Registry Only

on:
  push:
    branches: [  ]
    tags: [ "v*" ]
  workflow_dispatch: {}

env:
  # 你的镜像名称，最终会变成: docker-hub.zeabur.app/automation-aio
  IMAGE_NAME: automation

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: write # 既然不推 GHCR 了，这个权限其实可以去掉了
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      # --- 关键步骤：只登录私人仓库 ---
      - name: Login to Private Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PRIVATE_REGISTRY_HOST }}
          username: ${{ secrets.PRIVATE_REGISTRY_USER }}
          password: ${{ secrets.PRIVATE_REGISTRY_PWD }}

      # --- 关键修改：Images 列表只写私人仓库地址 ---
      - name: Extract meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          # 这样生成的标签会自动带上你的私有仓库前缀
          images: ${{ secrets.PRIVATE_REGISTRY_HOST }}/${{ env.IMAGE_NAME }}
          
          # 定义标签规则（保持不变）
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            # 如果是默认分支，自动打 latest 标签
            type=raw,value=latest,enable=${{ github.ref_name == github.event.repository.default_branch }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          # 这里会自动使用上面 meta 步骤生成的 tags（即包含私人仓库地址的 tag）
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # 既然是私有仓库，通常建议关闭缓存复用或者显式指定，这里保持原样即可
          # no-cache: true # 如果你发现构建有问题，可以取消注释这一行
